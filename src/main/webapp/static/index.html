<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>海顿元数据服务</title>
    <script type="text/javascript" src="js/tools.js"></script>
    <script type="text/javascript" src="js/project.js"></script>
    <script type="text/javascript" src="js/cluster.js"></script>
    <script type="text/javascript" src="js/module.js"></script>
    <script type="text/javascript" src="js/moduledetail.js"></script>
    <script type="text/javascript" src="js/package.js"></script>
    <script type="text/javascript" src="js/patch.js"></script>
    <script type="text/javascript" src="js/log.js"></script>
    <script type="text/javascript" src="js/export.js"></script>
    <script type="text/javascript" src="js/btngroup.js"></script>
    <script type="text/javascript" src="js/form.js"></script>
    <script type="text/javascript" src="js/original.js"></script>
    <script type="text/javascript" src="js/linked.js"></script>
    <script type="text/javascript" src="js/page.js"></script>
    <script type="text/javascript" src="js/advexport.js"></script>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="icon_font/iconfont.css">
    <style>
        body {
            font-family: "Microsoft YaHei", MSYH;
        }
    </style>
</head>
<body>
    <div class="wrap clearfix">
        <!--左侧导航-->
        <div class="nav">
            <div class="topinfo">

            </div>
            <div id="projectlist"></div>
        </div>
        <!--右侧内容-->
        <div class="pagecontent">
            <div class="current">
                <!--<span>您当前选择的是：</span>-->
                <span class="name" id="projectname"></span>
                <span class="info" id="envname"></span>
                <div class="userinfo clearfix">
                    <span id="usercode">&nbsp;</span>
                    <span id="exit" class="exit"><div class="iconfont">&#xe618;</div><span>注销</span></span>
                </div>
            </div>

                <!--环境-->
            <div id="clusterlist" class="environmentnav"></div>

            <div class="contentwrap">
                <div class="btncontainer clearfix">
                    <span id="exportbtn" class="selected">导出</span>
                    <span id="upgradebtn">升级</span>
                    <span id="advexportbtn">高级导出</span>
                </div>
                <div id="exportcontainer" class="exportcontainer showexport"></div>

                <div id="modulecontainer" class="modulecontainer">
                    <!--模块-->
                    <div id="modulelist"></div>

                    <!--目录-->
                    <div class="catalogue" id="moduledetail"></div>
                </div>
                <div id="advexportcontainer" class="advexportcontainer"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        new Promise(function(resolve, reject) {
            window.request('/metadata/COMMON/getServerDate', false, function(data){
                resolve(data);
            }, function(error) {
                if (error.status == '401') {
                    window.location.href = 'login.html';
                }
                reject(error);
            });
        }).then(function(data) {
            var exit = document.getElementById('exit');
            exit.addEventListener('click', function() {
                window.request('/logout', function(data) {
                    window.location.href = 'login.html';
                })
            });

            var usercode = document.getElementById('usercode');
            var userparam = window.location.href.geturlparam('usercode');
            usercode.innerHTML = userparam;

            var exportbtn = document.getElementById('exportbtn'); // 导出
            var upgradebtn = document.getElementById('upgradebtn'); // 升级
            var advexportbtn = document.getElementById('advexportbtn');  // 高级导出
            var exportcontainer = document.getElementById('exportcontainer');
            var modulecontainer = document.getElementById('modulecontainer');
            var advexportcontainer = document.getElementById('advexportcontainer');

            // 点击模块显示模块详情，点击返回，显示模块
            var _showmoduledetail = false;
            function showmoduledetail(value) {
                if (value !== undefined) {
                    this._showmoduledetail = value;
                    if (value) {
                        window.addclass(document.getElementById('modulecontainer'), 'showmoduledetail');
                    } else {
                        window.removeclass(document.getElementById('modulecontainer'), 'showmoduledetail');
                    }
                } else {
                    return this._showmoduledetail;
                }
            }

            // 开发环境下显示导出和高级导出页签，其他环境不显示
            function showtab(value) {
                if (value == "dev" || value == "test") {
                    window.removeclass(exportbtn, 'hidetab');
                    window.removeclass(advexportbtn, 'hidetab');
                    window.removeclass(upgradebtn, 'selected');
                    window.addclass(exportbtn, 'selected');
                    window.addclass(exportcontainer, 'showexport');
                    window.removeclass(modulecontainer, 'showmodule');
                } else {
                    window.addclass(exportbtn, 'hidetab');
                    window.addclass(advexportbtn, 'hidetab');
                    window.addclass(upgradebtn, 'selected');
                    window.addclass(modulecontainer, 'showmodule');
                    window.removeclass(exportcontainer, 'showexport');
                    window.removeclass(advexportcontainer, 'showadvexport');
                }
            }

            // 项目
            var projectlistcontainer = document.getElementById('projectlist');
            var plist = new projectlist(projectlistcontainer, {clickproc:function(data) {
                // console.log(data);
                window.removeclass(document.getElementById('exportcontainer').childNodes[0], 'selected');

                clist.data(data.envs);
                document.getElementById('projectname').innerHTML = data.name;
            }});

            // 环境
            var clusterlistcontainer = document.getElementById('clusterlist');
            var clist = new clusterlist(clusterlistcontainer, {clickproc:function(data) {
                // console.log('clist---', data);
                showtab(data.code); // 控制导出和高级导出页签的显示和隐藏

                loadmoduledata();
                document.getElementById('envname').innerHTML = data.name;

                loadmetadata();
            }});

            // 模块
            var modulelistcontainer = document.getElementById('modulelist');
            var mlist = new modulelist(modulelistcontainer, {clickproc:function(data) {
                // console.log('module--------', data);
                showmoduledetail(true);
                mdetail.data({moduledata:data});
                loadmoduledetaildata(data);
            }});

            // 模块详情
            var moduledetailcontainer = document.getElementById('moduledetail');
            var mdetail = new moduledetail(moduledetailcontainer, {returnproc:function(data) { // 返回按钮
                // console.log(data);
                showmoduledetail(false);
            }, upgradeproc:function(data, ver, prodver) {  // 升级按钮

                mdetail.status(1);
                var pdata = plist.current();
                var cdata = clist.current();
                var mdata = data.moduledata;
                var prodve = "";
                if (prodver != null) {
                    prodve = prodver.ver;
                }
                window.request('/metadata/UPGRADE/upgrade', {param:{project:pdata.code, env:cdata.code, modulecode:mdata.code, version:ver.ver, prover:prodve, t:Math.random()}}, function(data) {
                    // console.log('upgrade module data-----', data);
                    mlist.getitembycode(mdata.code).status(1);
                })
            }, statusproc:function(status, data) {
                if (!data) return;
                if (status == 0 || status == 3) {
                    loadmoduledetaildata(data.moduledata);
                }
            }});

            // 加载项目数据
            function loaddata() {
                window.request('/metadata/COMMON/getProjects', function(data) {
                    // console.log('project data---', data);
                    plist.data(data.data);
                })
            }

            // 加载模块数据
            function loadmoduledata() {
                showmoduledetail(false);
                mlist.data([]);
                var pdata = plist.current();
                var cdata = clist.current();
                window.request('/metadata/UPGRADE/getModuleList', {param:{project:pdata.code, env:cdata.code, t:Math.random()}}, function(data) {
                    // console.log('module data-----', data);
                    if (data.status !== 3200) {
                        alert(data.messages[0].message);
                        return;
                    }
                    mlist.data(data.data);
                })
            }

            // 更新模块数据
            function updatemoduledata() {
                var pdata = plist.current();
                var cdata = clist.current();
                if (!pdata || !cdata) return;
                window.request('/metadata/UPGRADE/getModuleListCache', {param:{project:pdata.code, env:cdata.code, t:Math.random()}}, function(data) {
                    // console.log('update module data-----', data);

                    for (var i = 0; i < data.data.length; i++) {
                        var d = data.data[i];
                        var item = mlist.getitembycode(d.code);
                        if (!item) {
                            mlist.addonedata(d);
                        } else {
                            // item._data.status = d.status;
                            item._data.datetime = d.datetime;
                            item.status(d.status);
                        }
                    }
                })
            }

            // 加载模块详情数据
            function loadmoduledetaildata(data) {
                var pdata = plist.current();
                var cdata = clist.current();
                var mdata = data;
                // console.log('mdata', mdata);
                window.request('/metadata/UPGRADE/getVersionList', {param:{project:pdata.code, env:cdata.code, modulecode:mdata.code, t:Math.random()}}, function(data) {
                    // console.log('package data----------', data);
                    var newdata = {moduledata:mdata, packdata:data.data.proj, prodpackdata:data.data.prod};
                    mdetail.data(newdata);
                })
            }

            // 更新日志数据
            function loadlogdata() {
                if (!plist.current() || !clist.current()) return;
                (function(pcode, ccode) { // 闭包，防止数据污染，在这里创建自己的副本
                    var logtime = mlist.getlogtime();
                    window.request('/metadata/UPGRADE/getLogs', {param:{project:pcode, env:ccode, datetime:logtime, t:Math.random()}}, function(data) {
                        // console.log('log data----', data);
                        if (pcode == plist.current().code && ccode == clist.current().code) {
                            mlist.addlogs(data.data);
                            mdetail.addlogs(data.data);
                        }
                    });
                })(plist.current().code, clist.current().code)
            }

            loaddata();

            // 导出功能  切换导出和升级  *****************************************************************************************
            exportbtn.addEventListener('click', function() {
                window.addclass(exportbtn, 'selected');
                window.removeclass(upgradebtn, 'selected');
                window.removeclass(advexportbtn, 'selected');

                window.addclass(exportcontainer, 'showexport');
                window.removeclass(modulecontainer, 'showmodule');
                window.removeclass(advexportcontainer, 'showadvexport');
            });
            upgradebtn.addEventListener('click', function() {
                window.addclass(upgradebtn, 'selected');
                window.removeclass(exportbtn, 'selected');
                window.removeclass(advexportbtn, 'selected');

                window.addclass(modulecontainer, 'showmodule');
                window.removeclass(exportcontainer, 'showexport');
                window.removeclass(advexportcontainer, 'showadvexport');
            });

            // 高级导出
            advexportbtn.addEventListener('click', function() {
               window.addclass(advexportbtn, 'selected');
               window.removeclass(exportbtn, 'selected');
               window.removeclass(upgradebtn, 'selected');

               window.addclass(advexportcontainer, 'showadvexport');
               window.removeclass(exportcontainer, 'showexport');
               window.removeclass(modulecontainer, 'showmodule');
            });

            var exportcontainer = document.getElementById('exportcontainer');
            var exportc = new exportcon(exportcontainer, {
                clickproc:function(data) { // 这个clickproc是从btngroup到export到html一层层传递过来的

                }, returnproc:function(data) { // 返回


                }, searchproc:function(data) { // 查询
                    loadsearchdata(data);

                }, addtolistproc:function(data) { // 添加导出
                    exportc.tolinked(data);
                    exportc.setoriginalstatus(data, true);

                }, exportproc:function(data) {
                    exportmetadata(data);
                }, removeproc:function(data) {
                    exportc.setoriginalstatus(data, false);
                }, pageclickproc:function(data) {
                    // console.log('page data', data);
                    loadsearchdata(data);
                }, appexportproc:function() { // 点击应用导出按钮
                    appexport();
                }
            });

            // 加载导出按钮数据
            function loadmetadata() {
                var pdata = plist.current();
                var cdata = clist.current();
                var type = data.type;
                window.request('/metadata/export/getMetaAndTenants', {param:{project:pdata.code, env:cdata.code, t:Math.random()}}, function(data) {
                    exportc.data({projectdata:plist.current(), envdata:clist.current(), tenantdata:data.data.tenants, btndata:data.data.meta});
                })
            }

            // 点击搜索按钮
            function loadsearchdata(data) {
                var pdata = plist.current();
                var cdata = clist.current();
                var type = data.type;
                window.request('/metadata/export/queryMetaData', {param:{project:pdata.code, env:cdata.code, metaType:type, tenantid:exportc._currenttenant.tenantid, metaDataCode:data.searchdata, page:data.page, rows:12, t:Math.random()}}, function (data) {
                    var resultdata = data.data;
                    exportc.showpage(resultdata.page.pageNo - 1, resultdata.page.totalPages);
                    // 刷新左侧表格，将请求回来的数据填入
                    exportc.showoriginaldata(resultdata);
                    var exportdatas = exportc.exportdatas();
                    exportc.updateoriginalstatus(exportdatas);
                });
            }

            // 导出
            function exportmetadata(data) {
                var pdata = plist.current();
                var cdata = clist.current();
                window.download('/metadata/export/exportMetaData'.addurlparam({project:pdata.code, env:cdata.code, metaType:data.metaType, tenantid:exportc._currenttenant.tenantid}), "POST", {data:JSON.stringify(data.exportdatas)});
                // post请求
                // window.request('/metadata/export/queryMetaData', {params:{project:pdata.code, env:cdata.code, metaType:data.metaType}, data:data.exportdatas}, "POST", function(data) {
                //
                // })
                // window.request('/metadata/export/queryMetaData?project=' + pdata.code + '&env=' + cdata.code + '&metaType=' + type, function (data) {
                //     console.log('导出接口调用成功----');
                // });
            }

            // 高级导出********************************************
            var advexportcontainer = document.getElementById('advexportcontainer');
            var advexp = new advexport(advexportcontainer, {
                advexportproc:function(data) {
                    advexportdatas(data);
                }
            });

            // 点击高级导出模块中的导出按钮
            function advexportdatas(data) {
                var pdata = plist.current();
                var cdata = clist.current();
                console.log('data--', data);

                window.download('/metadata/export/exportFieldMetaData'.addurlparam({project:pdata.code, env:cdata.code, table:data.table, fields:data.fields, where:data.where, t:Math.random()}));
            }

            // 点击应用导出按钮
            function appexport() {
                var pdata = plist.current();
                var cdata = clist.current();
                window.request('/metadata/export/getModuleList', {param:{project:pdata.code, env:cdata.code, t:Math.random()}}, function(data) {
                    // console.log('module data-----', data);
                    if (data.status !== 3200) {
                        alert(data.messages[0].message);
                        return;
                    }
                    var resultdata = data.data;
                    var moduledata = [];
                    for (var i = 0; i < resultdata.length; i++) {
                        moduledata.push({metaDataCode:resultdata[i].code, metaDataName:resultdata[i].name, metaDataType:"ALL", isappexport:1});
                    }
                    exportc.showtable({
                        type:"import",
                        name:"导入模版",
                        listItemName:"模板编码,模板名称",
                        linkedType:[],
                        hidesearch:1,
                        isappexport:1
                    });
                    exportc.showoriginaldata({voList:moduledata, page:{}});
                });
            }

            // 定时器：实时更新模块的变化（模块里面有日志和状态）
            setInterval(function() {
                // updatemoduledata();
                loadlogdata();
            }, 3000);
            // updatemoduledata();
            loadlogdata();
        })
    </script>
</body>
</html>
